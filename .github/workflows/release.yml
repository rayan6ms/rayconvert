name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  linux-binary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Build binary
        run: |
          mkdir -p dist
          go build -trimpath -ldflags "-s -w \
            -X main.version=${GITHUB_REF_NAME} \
            -X main.commit=${GITHUB_SHA::7} \
            -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o dist/rayconvert ./cmd/rayconvert
          cp man/rayconvert.1 dist/
          cp LICENSE dist/
          tar -czf dist/rayconvert-linux-x86_64.tar.gz -C dist rayconvert rayconvert.1 LICENSE

      - name: Upload release assets (binary)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/rayconvert-linux-x86_64.tar.gz

  flatpak:
    runs-on: ubuntu-latest
    needs: linux-binary
    steps:
      - uses: actions/checkout@v4

      - name: Install Flatpak tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - name: Add Flathub and install runtimes
        run: |
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install -y flathub \
            org.freedesktop.Platform//25.08 \
            org.freedesktop.Sdk//25.08 \
            org.freedesktop.Sdk.Extension.golang//25.08

      - name: Build Flatpak bundle
        run: |
          rm -rf build-dir repo
          flatpak-builder --force-clean --repo=repo build-dir flatpak/io.github.rayan6ms.Rayconvert.yml
          flatpak build-update-repo repo
          flatpak build-bundle repo rayconvert.flatpak io.github.rayan6ms.Rayconvert \
            --runtime-repo=https://flathub.org/repo/flathub.flatpakrepo

      - name: Upload release assets (flatpak)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            rayconvert.flatpak
